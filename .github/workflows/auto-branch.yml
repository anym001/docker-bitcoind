name: Auto Create Version Branch

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch latest Bitcoin Core releases
        id: fetch
        run: |
          RELEASES=$(curl -s https://api.github.com/repos/bitcoin/bitcoin/releases)

          VALID_TAG=$(
            echo "$RELEASES" | jq -r '
              [ .[].tag_name
                | select(test("^v[0-9]+\\.[0-9]+$"))                   # standard releases
                | select( (sub("^v";"") | tonumber) >= 28.0 )          # only >= v28.0
              ][0]'
          )

          echo "valid_tag=$VALID_TAG" >> $GITHUB_OUTPUT

      - name: Stop if no valid release found
        if: ${{ steps.fetch.outputs.valid_tag == '' }}
        run: |
          echo "No valid >=28.0, non-RC release found."
          exit 0

      - name: Check if version branch already exists
        id: branch
        run: |
          VERSION="${{ steps.fetch.outputs.valid_tag }}"
          if git ls-remote --heads origin "$VERSION" | grep "$VERSION" > /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if branch already exists
        if: steps.branch.outputs.exists == 'true'
        run: echo "Branch already exists — nothing to do."

      - name: Check if Docker image already exists in GHCR
        id: ghcr
        run: |
          VERSION="${{ steps.fetch.outputs.valid_tag }}"
          IMAGE="ghcr.io/${{ github.repository }}:$VERSION"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://ghcr.io/v2/${{ github.repository }}/manifests/$VERSION)

          if [ "$STATUS" -eq 200 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if Docker image already exists
        if: steps.ghcr.outputs.exists == 'true'
        run: echo "Docker image already exists in GHCR — nothing to do."

      - name: Create version branch with build workflow
        if: steps.branch.outputs.exists == 'false' && steps.ghcr.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.fetch.outputs.valid_tag }}"
          echo "Creating new version branch: $VERSION"

          git checkout -b "$VERSION"

          mkdir -p .github/workflows
          cp .github/workflows/build.yml .github/workflows/build.yml

          git add .github/workflows/build.yml
          git commit -m "Add build workflow for version $VERSION"
          git push origin "$VERSION"
